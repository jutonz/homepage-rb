<%= simple_form_for(
  [@recipe_group, @recipe, @recipe_ingredient],
  url: @recipe_ingredient.persisted? ? recipe_group_recipe_ingredient_path(@recipe_group, @recipe, @recipe_ingredient) : recipe_group_recipe_ingredients_path(@recipe_group, @recipe)
) do |form| %>
  <div 
    data-controller="ingredient-autocomplete" 
    data-ingredient-autocomplete-suggestions-value="<%= @available_ingredients.map { |ing| { id: ing.id, name: ing.name } }.to_json %>"
    class="relative"
  >
    <%= form.input(
      :ingredient_name, 
      label: "Ingredient",
      placeholder: "Type ingredient name (existing or new)...",
      value: @recipe_ingredient.ingredient&.name,
      input_html: {
        data: { 
          ingredient_autocomplete_target: "input",
          action: "input->ingredient-autocomplete#filter keydown->ingredient-autocomplete#navigate"
        },
        autofocus: true,
        autocomplete: "off"
      }
    ) %>
    <div 
      data-ingredient-autocomplete-target="dropdown" 
      class="hidden absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto divide-y divide-gray-100"
      aria-hidden="true"
    >
      <!-- Suggestions populated by Stimulus -->
    </div>
  </div>

  <%= form.input(:quantity_string, placeholder: "e.g., 2, 1/2, 1.5") %>

  <%= form.association(
    :unit,
    as: :grouped_select,
    collection: Recipes::Unit.order(:name).group_by(&:unit_type).to_a,
    group_method: :last,
    prompt: "Choose a unit",
    include_blank: false
  ) %>

  <div class="flex gap-2">
    <%= form.button(:submit, class: "button") %>
    <%= link_to(
      "Cancel",
      recipe_group_recipe_ingredients_path(@recipe_group, @recipe),
      class: "button button--secondary"
    ) %>
  </div>
<% end %>

<div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
  <div class="text-blue-800 font-medium mb-2">ðŸ’¡ Tip</div>
  <div class="text-blue-700 text-sm">
    Start typing an ingredient name above. If it exists, you'll see suggestions. If not, a new ingredient will be created automatically when you submit the form.
  </div>
</div>
